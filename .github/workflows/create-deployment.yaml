name: Generate Kubernetes Deployment YAML

on:
  workflow_dispatch:
    inputs:
      name:
        description: 'Name of Deployment and container (required)'
        required: true
        default: ''
      labels:
        description: 'Labels field'
        required: false
        default: ''
      replicas:
        description: 'Number of replicas (defaults to 3)'
        required: false
        default: '3'
      envs:
        description: |
          Environment variables. Options:
          - Comma separeted: KEY=VALUE values.
        required: false
        default: ''

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Generate Deployment YAML
        id: generate
        run: |
          python generate_deployment.py \
            --name "${{ github.event.inputs.name }}" \
            ${{ github.event.inputs.labels && format('--labels "{0}"', github.event.inputs.labels) || '' }} \
            ${{ github.event.inputs.replicas && format('--replicas {0}', github.event.inputs.replicas) || '' }} \
            ${{ github.event.inputs.envs && format('--envs "{0}"', github.event.inputs.envs) || '' }} \
            > deployment.yaml
          cat deployment.yaml

      - name: Add Deployment YAML to summary
        run: |
          echo '## Generated Deployment YAML' >> $GITHUB_STEP_SUMMARY
          echo '' >> $GITHUB_STEP_SUMMARY
          echo '```yaml' >> $GITHUB_STEP_SUMMARY
          cat deployment.yaml >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
